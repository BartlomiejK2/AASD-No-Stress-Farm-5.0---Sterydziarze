services:
  xmpp_server:
    image: tigase/tigase-xmpp-server:8.0.0
    container_name: xmpp_server
    ports:
      - "8480:8080"
      - "5422:5222"
    environment:
      - DB_ROOT_USER=admin
      - DB_ROOT_PASS=admin
      - ADMIN_JID=admin@localhost
      - ADMIN_PASSWORD=admin
    volumes:
      - ./tigase/config/tigase.conf:/home/tigase/tigase-server/etc/tigase.conf
      - ./tigase/config/config.tdsl:/home/tigase/tigase-server/etc/config.tdsl

  cow_analyzer:
    build: ./cow_analysis
    container_name: cow_analyzer
    depends_on:
      - xmpp_server
    environment:
      - NAME=cow_analyzer
      - PASSWORD=secret
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  spatial_analyzer:
    build: ./spatial_analysis
    container_name: spatial_analyzer
    depends_on:
      cow_analyzer:
        condition: service_healthy
    environment:
      - NAME=spatial_analyzer
      - PASSWORD=secret
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  mucka:
    build: ./cow
    container_name: mucka
    depends_on:
      spatial_analyzer:
        condition: service_healthy
    environment:
      - NAME=mucka
      - PASSWORD=secret
      - SUCCES_RATE=0.8
      - SLEEP_TIME=2.5
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  krasula:
    build: ./cow
    container_name: krasula
    depends_on:
      mucka:
        condition: service_healthy
    environment:
      - NAME=krasula
      - PASSWORD=secret
      - SUCCES_RATE=0.8
      - SLEEP_TIME=2.5
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  zosia:
    build: ./cow
    container_name: zosia
    depends_on:
      krasula:
        condition: service_healthy
    environment:
      - NAME=zosia
      - PASSWORD=secret
      - SUCCES_RATE=0.8
      - SLEEP_TIME=2.5
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  obora1:
    build: ./space
    container_name: obora1
    depends_on:
      zosia:
        condition: service_healthy
    environment:
      - PASSWORD=secret
      - NAME=obora1
      - POSITION_X=0
      - POSITION_Y=0
      - SUCCES_RATE=0.8
      - SLEEP_TIME=2.5
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  obora2:
    build: ./space
    container_name: obora2
    depends_on:
      obora1:
        condition: service_healthy
    environment:
      - PASSWORD=secret
      - NAME=obora2
      - POSITION_X=10
      - POSITION_Y=10
      - SUCCES_RATE=0.8
      - SLEEP_TIME=2.5
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20

  farmer:
    build: ./farmer
    container_name: farmer
    depends_on:
      cow_analyzer:
        condition: service_healthy
    environment:
      - PASSWORD=secret
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/agent_ready"]
      interval: 3s
      timeout: 2s
      retries: 20


